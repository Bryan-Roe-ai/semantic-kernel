<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Studio Chat</title>
    <style>
        :root {
            /* Light theme variables */
            --light-bg: #f5f5f5;
            --light-card-bg: #ffffff;
            --light-text: #333333;
            --light-secondary-text: #666666;
            --light-border: #cccccc;
            --light-primary: #4caf50;
            --light-primary-hover: #45a049;
            --light-shadow: rgba(0, 0, 0, 0.1);

            /* Dark theme variables will be defined in the dark-mode section */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, Arial, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--light-text);
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        h1 {
            color: var(--light-text);
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 2rem;
        }

        #chatLog {
            border: 1px solid var(--light-border);
            padding: 20px;
            height: 450px;
            margin-bottom: 20px;
            overflow-y: auto;
            background-color: var(--light-card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--light-shadow);
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            position: relative;
        }

        #chatLog::-webkit-scrollbar {
            width: 8px;
        }

        #chatLog::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #chatLog::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .user-message {
            background-color: #e3f2fd;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 18px 18px 4px 18px;
            max-width: 85%;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 1px 2px var(--light-shadow);
            word-break: break-word;
            position: relative;
            animation: slideInRight 0.3s ease;
        }

        .ai-message {
            background-color: #f1f1f1;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 18px 18px 18px 4px;
            max-width: 85%;
            align-self: flex-start;
            box-shadow: 0 1px 2px var(--light-shadow);
            word-break: break-word;
            position: relative;
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #userInput {
            width: 100%;
            padding: 12px 15px;
            box-sizing: border-box;
            border: 1px solid var(--light-border);
            border-radius: 8px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 1rem;
            box-shadow: 0 1px 3px var(--light-shadow);
            transition: all 0.2s ease;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--light-primary);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        button {
            background-color: var(--light-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--light-shadow);
            transition: all 0.2s ease;
        }

        button:hover {
            background-color: var(--light-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--light-shadow);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px var(--light-shadow);
        }

        .status-indicator {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            transition: all 0.3s ease;
        }

        .status-connected {
            background-color: #4caf50;
            box-shadow: 0 0 5px #4caf50;
        }

        .status-disconnected {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        .status-container {
            float: right;
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 1px 3px var(--light-shadow);
        }

        .settings-container {
            margin-bottom: 25px;
            padding: 20px;
            background-color: var(--light-card-bg);
            border-radius: 10px;
            box-shadow: 0 3px 10px var(--light-shadow);
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }

        label {
            margin-right: 8px;
            font-weight: 500;
        }

        select,
        input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--light-border);
            background-color: white;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--light-primary);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            margin: 10px 0;
            padding: 8px 16px;
            background-color: rgba(241, 241, 241, 0.7);
            border-radius: 20px;
            width: fit-content;
            box-shadow: 0 1px 3px var(--light-shadow);
            animation: fadeIn 0.3s ease;
            font-size: 14px;
        }

        .typing-dot {
            height: 8px;
            width: 8px;
            background-color: #666;
            border-radius: 50%;
            margin: 0 3px;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.6;
            }

            30% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .copy-btn {
            opacity: 0;
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 3px 8px;
            font-size: 12px;
            background-color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        .ai-message:hover .copy-btn {
            opacity: 1;
        }

        /* High contrast mode with improved accessibility */
        :root {
            --hc-bg: #000;
            --hc-text: #fff;
            --hc-border: #fff;
            --hc-accent: #ff0;
            --hc-secondary: #444;
            --hc-ui-bg: #111;
        }

        body.high-contrast {
            background-color: var(--hc-bg);
            color: var(--hc-text);
        }

        body.high-contrast #chatLog {
            background-color: var(--hc-bg);
            color: var(--hc-text);
            border-color: var(--hc-border);
            border-width: 2px;
        }

        body.high-contrast .ai-message {
            background-color: var(--hc-secondary);
            color: var(--hc-text);
            border: 2px solid var(--hc-border);
            margin: 10px 0;
        }

        body.high-contrast .user-message {
            background-color: var(--hc-accent);
            color: var(--hc-bg);
            border: 2px solid var(--hc-border);
            font-weight: bold;
            margin: 10px 0;
        }

        body.high-contrast .settings-container {
            background-color: var(--hc-ui-bg);
            color: var(--hc-text);
            border: 2px solid var(--hc-border);
            padding: 15px;
        }

        body.high-contrast button {
            background-color: var(--hc-text);
            color: var(--hc-bg);
            border: 2px solid var(--hc-accent);
            font-weight: bold;
            box-shadow: none;
        }

        body.high-contrast button:hover {
            background-color: var(--hc-accent);
            color: var(--hc-bg);
        }

        body.high-contrast input,
        body.high-contrast select,
        body.high-contrast textarea {
            background-color: var(--hc-bg);
            color: var(--hc-text);
            border: 2px solid var(--hc-border);
        }

        body.high-contrast input:focus,
        body.high-contrast select:focus,
        body.high-contrast textarea:focus {
            outline: 3px solid var(--hc-accent);
        }

        body.high-contrast .status-connected {
            background-color: var(--hc-accent);
            box-shadow: 0 0 0 2px var(--hc-border);
        }

        body.high-contrast .status-disconnected {
            background-color: #f00;
            box-shadow: 0 0 0 2px var(--hc-border);
        }

        /* Code block styling */
        body.dark-mode pre,
        body.dark-mode code {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            padding: 0.2em 0.4em;
        }

        body.dark-mode pre {
            padding: 1em;
            overflow-x: auto;
            margin: 1em 0;
            position: relative;
        }

        body.dark-mode pre code {
            background-color: transparent;
            border: none;
            padding: 0;
            color: #e0e0e0;
        }

        /* Additional Dark Mode Enhancements */
        body.dark-mode .app-header {
            position: relative;
            margin-bottom: 30px;
            padding-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body.dark-mode .app-header:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--dark-primary), transparent);
            border-radius: 3px;
            opacity: 0.5;
        }

        /* Enhanced button styles for primary actions */
        body.dark-mode #sendButton {
            background: linear-gradient(145deg, #7c5af0, #6241e4);
            font-weight: 600;
            padding: 12px 28px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            border-radius: 30px;
            margin-right: 10px;
            box-shadow: 
                0 5px 15px rgba(124, 90, 240, 0.2),
                0 0 5px rgba(124, 90, 240, 0.1);
            border: 1px solid rgba(124, 90, 240, 0.3);
        }

        body.dark-mode #sendButton::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                transparent 100%
            );
            z-index: 1;
            transition: 0.6s;
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { left: -100%; }
            20% { left: 100%; }
            100% { left: 100%; }
        }

        body.dark-mode #sendButton:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(0deg, rgba(255,255,255,0.08) 0%, transparent 50%);
            z-index: -1;
        }

        body.dark-mode #sendButton:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 20px rgba(124, 90, 240, 0.3),
                0 0 10px rgba(124, 90, 240, 0.2);
        }

        /* Message timestamps styling */
        body.dark-mode .message-timestamp {
            font-size: 0.75rem;
            color: var(--dark-muted-text);
            margin-top: 6px;
            display: block;
            text-align: right;
        }

        /* Improve scrollbar for all scrollable areas */
        body.dark-mode *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        body.dark-mode *::-webkit-scrollbar-track {
            background: var(--dark-scrollbar-track);
            border-radius: 10px;
        }

        body.dark-mode *::-webkit-scrollbar-thumb {
            background: var(--dark-scrollbar-thumb);
            border-radius: 10px;
            border: 2px solid var(--dark-scrollbar-track);
        }

        body.dark-mode *::-webkit-scrollbar-thumb:hover {
            background: var(--dark-primary);
        }

        /* User input focus state enhancement */
        body.dark-mode #userInput:focus {
            border-color: var(--dark-primary);
            box-shadow: 0 0 0 3px var(--dark-highlight-alpha), inset 0 2px 10px rgba(0, 0, 0, 0.15);
            background-color: rgba(30, 30, 45, 0.8);
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            body.dark-mode {
                padding: 10px;
            }

            body.dark-mode .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }

            body.dark-mode .setting-group {
                width: 100%;
                margin-bottom: 15px;
            }

            body.dark-mode button {
                padding: 10px 14px;
                font-size: 14px;
                margin: 3px;
            }

            body.dark-mode #chatLog {
                height: 380px;
                padding: 16px;
            }

            body.dark-mode .user-message,
            body.dark-mode .ai-message {
                max-width: 95%;
                margin: 10px 0;
            }
        }

        /* Button hover animations */
        body.dark-mode button:active {
            transform: scale(0.97);
        }

        /* Glassmorphism effect for cards/containers */
        body.dark-mode .glassmorphism {
            background: rgba(30, 30, 45, 0.7);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--dark-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* Code syntax highlighting for dark mode */
        body.dark-mode .token.comment,
        body.dark-mode .token.prolog,
        body.dark-mode .token.doctype,
        body.dark-mode .token.cdata {
            color: #6a9955;
        }

        body.dark-mode .token.punctuation {
            color: #d4d4d4;
        }

        body.dark-mode .token.property,
        body.dark-mode .token.tag,
        body.dark-mode .token.boolean,
        body.dark-mode .token.number,
        body.dark-mode .token.constant,
        body.dark-mode .token.symbol,
        body.dark-mode .token.deleted {
            color: #ce9178;
        }

        body.dark-mode .token.selector,
        body.dark-mode .token.attr-name,
        body.dark-mode .token.string,
        body.dark-mode .token.char,
        body.dark-mode .token.builtin,
        body.dark-mode .token.inserted {
            color: #b5cea8;
        }

        body.dark-mode .token.operator,
        body.dark-mode .token.entity,
        body.dark-mode .token.url,
        body.dark-mode .language-css .token.string,
        body.dark-mode .style .token.string {
            color: #d4d4d4;
        }

        body.dark-mode .token.atrule,
        body.dark-mode .token.attr-value,
        body.dark-mode .token.keyword {
            color: #569cd6;
        }

        body.dark-mode .token.function,
        body.dark-mode .token.class-name {
            color: #4ec9b0;
        }

        body.dark-mode .token.regex,
        body.dark-mode .token.important,
        body.dark-mode .token.variable {
            color: #dcdcaa;
        }

        /* API key input width */
        #apiKeyInput {
            width: 200px;
        }

        /* System prompt input width */
        #systemPrompt {
            width: 400px;
        }

        body.dark-mode .typing-indicator {
            display: none;
            align-items: center;
            margin: 10px 0;
            padding: 10px 18px;
            background: var(--dark-gradient-1);
            border-radius: 20px;
            width: fit-content;
            box-shadow: 0 4px 12px var(--dark-shadow);
            animation: fadeIn 0.3s ease;
            font-size: 14px;
            border: 1px solid var(--dark-border);
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .typing-indicator::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--dark-primary), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        body.dark-mode .typing-indicator span {
            color: var(--dark-secondary-text);
            margin-right: 8px;
            font-weight: 500;
        }

        body.dark-mode .typing-dot {
            height: 8px;
            width: 8px;
            background-color: var(--dark-primary);
            border-radius: 50%;
            margin: 0 3px;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
            box-shadow: 0 0 8px rgba(124, 90, 240, 0.5);
        }
    </style>
</head>

<body>
    <div class="status-container">
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="statusText">Checking connection...</span>
    </div>
    <div class="app-header">
        <h1>LM Studio Chat</h1>
        <div class="status-container">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">Checking connection...</span>
        </div>
    </div>

    <div class="settings-container" id="settingsPanel">
        <div class="settings-header">
            <h3>Settings</h3>
            <button id="toggleSettingsBtn" onclick="toggleSettings()" title="Toggle settings visibility">▼</button>
        </div>

        <div id="settingsContent">
            <div class="settings-row">
                <div class="setting-group">
                    <label for="modelSelect">Model:</label>
                    <select id="modelSelect" class="select-styled">
                        <option value="microsoft/phi-4-mini-reasoning">Phi-4-Mini</option>
                        <option value="llama3-8b-instruct">Llama 3 8B</option>
                        <option value="mistral-nemo-instruct-2407">Mistral Nemo</option>
                    </select>
                </div>
                <div class="setting-group slider-group">
                    <label for="temperatureInput">Temperature: <span id="temperatureValue">0.7</span></label>
                    <input type="range" id="temperatureInput" min="0" max="1" step="0.1" value="0.7">
                </div>
                <div class="setting-group">
                    <label for="maxTokensInput">Max Tokens:</label>
                    <input type="number" id="maxTokensInput" min="100" max="2000" value="500">
                </div>
            </div>

            <div class="settings-row">
                <div class="setting-group full-width">
                    <label for="systemPrompt">System Prompt:</label>
                    <div class="prompt-container">
                        <input type="text" id="systemPrompt" placeholder="Optional system prompt">
                        <div class="preset-container">
                            <label for="presetSelect">Preset:</label>
                            <select id="presetSelect" class="select-styled">
                                <option value="">None</option>
                                <option value="friendly">Friendly Assistant</option>
                                <option value="coder">Code Helper</option>
                                <option value="summarizer">Summarizer</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <div class="settings-row tools-row">
                <div class="tool-group">
                    <span class="tool-label">File Tools:</span>
                    <div class="file-upload-container">
                        <label for="fileUpload" class="file-upload-label">
                            <span>📂 Choose File</span>
                        </label>
                        <input type="file" id="fileUpload" multiple>
                        <button onclick="handleFileUpload()" class="tool-button">Send File</button>
                    </div>
                </div>

                <div class="tool-group">
                    <span class="tool-label">Export:</span>
                    <div class="export-buttons">
                        <button onclick="exportChat('txt')" class="tool-button">TXT</button>
                        <button onclick="exportChat('md')" class="tool-button">MD</button>
                        <button onclick="exportChat('pdf')" class="tool-button">PDF</button>
                    </div>
                </div>

                <div class="tool-group">
                    <span class="tool-label">Input & Output:</span>
                    <div>
                        <button onclick="startVoiceInput()" id="voiceInputBtn" class="tool-button"><span
                                class="btn-icon">🎤</span> Voice</button>
                        <button onclick="toggleTTS()" id="ttsBtn" class="tool-button"><span class="btn-icon">🔊</span>
                            TTS</button>
                        <button onclick="generateImage()" class="tool-button"><span class="btn-icon">🖼️</span>
                            Image</button>
                    </div>
                </div>
            </div>

            <div class="settings-divider"></div>

            <div class="settings-row">
                <div class="setting-group">
                    <label for="apiKeyInput">API Key:</label>
                    <div class="api-key-container">
                        <input type="password" id="apiKeyInput" placeholder="Optional API Key">
                        <button onclick="saveApiKey()" class="small-button">Save</button>
                    </div>
                </div>
                <div class="setting-group">
                    <label for="themeSelect">Theme:</label>
                    <select id="themeSelect" onchange="changeTheme()" class="select-styled">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="high-contrast">High Contrast</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add toggle settings panel function
        function toggleSettings() {
            const settingsContent = document.getElementById('settingsContent');
            const toggleBtn = document.getElementById('toggleSettingsBtn');

            if (settingsContent.style.display === 'none') {
                settingsContent.style.display = 'block';
                toggleBtn.textContent = '▼';
                localStorage.setItem('settingsExpanded', 'true');
            } else {
                settingsContent.style.display = 'none';
                toggleBtn.textContent = '▲';
                localStorage.setItem('settingsExpanded', 'false');
            }
        }

        // Apply settings visibility based on saved preference
        document.addEventListener('DOMContentLoaded', () => {
            const settingsExpanded = localStorage.getItem('settingsExpanded');
            if (settingsExpanded === 'false') {
                document.getElementById('settingsContent').style.display = 'none';
                document.getElementById('toggleSettingsBtn').textContent = '▲';
            }
        });
    </script>

    <div id="chatLog"></div>
    <div class="typing-indicator" id="typingIndicator">
        <span>AI is thinking</span>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>
    <textarea id="userInput" rows="3" placeholder="Type your message here..."></textarea><br>
    <button onclick="sendMessage()" id="sendButton">Send</button>
    <button onclick="clearChat()">Clear Chat</button>
    <button onclick="checkBackendStatus()">Check Connection</button>
    <button onclick="toggleDarkMode()" id="darkModeBtn">Toggle Dark Mode</button>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkBackendStatus();

            // Apply preferred theme on load - default to dark mode
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeSelect').value = 'dark';
                document.getElementById('darkModeBtn').innerHTML = '<i class="mode-icon">☀️</i> Light Mode';
            } else if (savedTheme === 'high-contrast') {
                document.body.classList.add('high-contrast');
                document.getElementById('themeSelect').value = 'high-contrast';
            } else {
                // If it's light mode
                document.getElementById('darkModeBtn').innerHTML = '<i class="mode-icon">🌙</i> Dark Mode';
            }

            // Add event listener for Enter key
            document.getElementById('userInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Focus on input field by default
            setTimeout(() => {
                document.getElementById('userInput').focus();
            }, 500);

            // Update temperature display when slider changes
            document.getElementById('temperatureInput').addEventListener('input', function () {
                document.getElementById('temperatureValue').textContent = this.value;
            });

            // Add tooltips to buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent === 'Send') button.title = 'Send message (or press Enter)';
                if (button.textContent === 'Clear Chat') button.title = 'Clear current conversation';
                if (button.textContent === 'Check Connection') button.title = 'Check connection to backend server';
                if (button.textContent === 'Toggle Dark Mode') button.title = 'Switch between light and dark modes';
                if (button.textContent === 'Send File') button.title = 'Upload and process file content';
                if (button.textContent.includes('Export')) button.title = 'Export conversation in ' + button.textContent.split(' ')[1] + ' format';
                if (button.textContent.includes('Voice')) button.title = 'Use microphone for voice input';
                if (button.textContent.includes('TTS')) button.title = 'Toggle text-to-speech for AI responses';
                if (button.textContent.includes('Image')) button.title = 'Generate an image based on text description';
            });

            // Load chat history
            loadChatHistory();

            // Start with a welcome message if no history
            if (document.getElementById('chatLog').children.length === 0) {
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'ai-message';
                aiMessageDiv.innerHTML = renderMarkdown("### Welcome to LM Studio Chat\n\nI'm your AI assistant powered by LM Studio. How can I help you today?");
                document.getElementById('chatLog').appendChild(aiMessageDiv);
                attachCopyButtons();
                saveChatHistory();
            }

            // Handle resize of input area
            const resizeTextarea = () => {
                const textarea = document.getElementById('userInput');
                textarea.style.height = 'auto';
                const newHeight = Math.min(200, Math.max(60, textarea.scrollHeight));
                textarea.style.height = newHeight + 'px';
            };

            document.getElementById('userInput').addEventListener('input', resizeTextarea);
        });        // Enhanced dark mode toggle
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const isHighContrast = document.body.classList.contains('high-contrast');

            // Clear existing classes
            document.body.classList.remove('dark-mode', 'high-contrast');

            // Toggle between light and dark (preserving high contrast if active)
            if (!isDarkMode && !isHighContrast) {
                document.body.classList.add('dark-mode');
                document.getElementById('themeSelect').value = 'dark';
                localStorage.setItem('theme', 'dark');
                document.getElementById('darkModeBtn').textContent = 'Switch to Light Mode';
                document.getElementById('darkModeBtn').innerHTML = '<i class="mode-icon">☀️</i> Light Mode';
            } else {
                document.getElementById('themeSelect').value = 'light';
                localStorage.setItem('theme', 'light');
                document.getElementById('darkModeBtn').innerHTML = '<i class="mode-icon">🌙</i> Dark Mode';
            }

            // Add smooth transition effect
            document.body.style.transition = 'background-color 0.5s ease, color 0.5s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 500);
        }

        // Add dark mode styles
        const darkStyle = document.createElement('style');
        darkStyle.textContent = `
        :root {
            /* Modern Dark Theme Variables */
            --dark-bg: #0f0f13;
            --dark-card-bg: #1a1a25;
            --dark-accent: #22222e;
            --dark-text: #e4e4f0;
            --dark-secondary-text: #aeaebc;
            --dark-muted-text: #8a8a99;
            --dark-border: rgba(87, 87, 141, 0.3);
            --dark-primary: #7c5af0;
            --dark-primary-hover: #8e6bf5;
            --dark-primary-active: #6241e4;
            --dark-user-msg-bg: #2b3353;
            --dark-ai-msg-bg: #1f2433;
            --dark-scrollbar-thumb: #454564;
            --dark-scrollbar-track: #1e1e28;
            --dark-input-bg: #1c1c27;
            --dark-input-border: #393953;
            --dark-shadow: rgba(0, 0, 0, 0.4);
            --dark-highlight: #7c5af0;
            --dark-highlight-alpha: rgba(124, 90, 240, 0.15);
            --dark-green: #4ade80;
            --dark-red: #f87171;
            --dark-status-good: #4ade80;
            --dark-status-bad: #f87171;
            --dark-gradient-1: linear-gradient(145deg, #1f1f2c, #18181f);
            --dark-gradient-2: linear-gradient(145deg, #222234, #1c1c27);
            --dark-button-gradient: linear-gradient(145deg, #7c5af0, #6241e4);
            --dark-hover-bg: rgba(255, 255, 255, 0.03);
            --dark-active-bg: rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            transition: all 0.3s ease;
            background: 
                linear-gradient(40deg, rgba(15, 15, 19, 1) 0%, rgba(26, 26, 37, 1) 100%);
            background-size: 400% 400%;
            animation: gradientBG 45s ease infinite;
            position: relative;
        }

        body.dark-mode::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 10%, rgba(124, 90, 240, 0.03) 0%, transparent 30%),
                radial-gradient(circle at 80% 20%, rgba(124, 90, 240, 0.02) 0%, transparent 20%),
                radial-gradient(circle at 10% 80%, rgba(98, 65, 228, 0.03) 0%, transparent 30%),
                radial-gradient(circle at 90% 90%, rgba(142, 107, 245, 0.03) 0%, transparent 20%);
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body.dark-mode h1 {
            color: var(--dark-text);
            font-weight: 700;
            letter-spacing: 0.015em;
            margin-top: 1rem;
            margin-bottom: 1.8rem;
            text-shadow: 0 2px 10px rgba(124, 90, 240, 0.2);
        }
        
        body.dark-mode h3 {
            color: var(--dark-text);
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        
        body.dark-mode #chatLog {
            background-color: var(--dark-card-bg);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            box-shadow: 
                0 10px 25px -5px rgba(0, 0, 0, 0.25),
                0 0 20px 5px rgba(124, 90, 240, 0.05);
            scrollbar-width: thin;
            padding: 24px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        
        body.dark-mode #chatLog::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at center,
                rgba(124, 90, 240, 0.01) 0%,
                rgba(124, 90, 240, 0.005) 25%, 
                transparent 70%
            );
            z-index: -1;
            animation: rotateGradient 30s linear infinite;
        }
        
        @keyframes rotateGradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body.dark-mode #chatLog::-webkit-scrollbar {
            width: 8px;
        }
        
        body.dark-mode #chatLog::-webkit-scrollbar-track {
            background: var(--dark-scrollbar-track);
            border-radius: 10px;
        }
        
        body.dark-mode #chatLog::-webkit-scrollbar-thumb {
            background: var(--dark-scrollbar-thumb);
            border-radius: 10px;
            border: 2px solid var(--dark-scrollbar-track);
        }
        
        body.dark-mode #chatLog::-webkit-scrollbar-thumb:hover {
            background: var(--dark-primary);
        }
        
        body.dark-mode .ai-message {
            background: var(--dark-gradient-1);
            color: var(--dark-text);
            border-left: 3px solid var(--dark-highlight);
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            margin: 14px 1px;
            animation: fadeInLeft 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 2px 12px 12px 12px;
            position: relative;
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            padding: 14px 18px;
        }
        
        body.dark-mode .ai-message:before {
            content: '';
            position: absolute;
            left: -8px;
            top: 12px;
            width: 10px;
            height: 10px;
            background: var(--dark-ai-msg-bg);
            transform: rotate(45deg);
            border-left: 1px solid var(--dark-border);
            border-bottom: 1px solid var(--dark-border);
        }
        
        body.dark-mode .user-message {
            background: var(--dark-gradient-2);
            color: var(--dark-text);
            border-right: 3px solid var(--dark-primary);
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.2);
            margin: 14px 1px;
            padding: 14px 18px;
            animation: fadeInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 12px 2px 12px 12px;
            position: relative;
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
        }
        
        body.dark-mode .user-message:after {
            content: '';
            position: absolute;
            right: -8px;
            top: 12px;
            width: 10px;
            height: 10px;
            background: var(--dark-user-msg-bg);
            transform: rotate(45deg);
            border-right: 1px solid var(--dark-border);
            border-top: 1px solid var(--dark-border);
        }
        
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        body.dark-mode .settings-container {
            background: var(--dark-gradient-1);
            border: 1px solid var(--dark-border);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            margin-bottom: 30px;
            padding: 24px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .settings-container:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--dark-highlight), transparent);
            opacity: 0.3;
        }
        
        body.dark-mode .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        body.dark-mode button {
            background: var(--dark-button-gradient);
            color: white;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            padding: 10px 18px;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.2);
            font-weight: 500;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }
        
        body.dark-mode button:hover {
            background: var(--dark-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(108, 92, 231, 0.3);
        }
        
        body.dark-mode button:active {
            transform: translateY(0);
            background: var(--dark-primary-active);
            box-shadow: 0 2px 8px rgba(108, 92, 231, 0.15);
        }
        
        body.dark-mode button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        body.dark-mode button:hover:before {
            left: 100%;
        }
        
        body.dark-mode input, 
        body.dark-mode textarea, 
        body.dark-mode select {
            background-color: var(--dark-input-bg);
            color: var(--dark-text);
            border: 1px solid var(--dark-input-border);
            border-radius: 8px;
            transition: all 0.2s ease;
            padding: 10px 14px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        body.dark-mode input:hover, 
        body.dark-mode textarea:hover, 
        body.dark-mode select:hover {
            border-color: var(--dark-primary);
        }
        
        body.dark-mode input:focus, 
        body.dark-mode textarea:focus, 
        body.dark-mode select:focus {
            border-color: var(--dark-primary);
            outline: none;
            box-shadow: 0 0 0 3px var(--dark-highlight-alpha), inset 0 2px 8px rgba(0, 0, 0, 0.15);
            background-color: rgba(30, 30, 45, 0.8);
        }
        
        body.dark-mode #userInput {
            background: var(--dark-input-bg);
            color: var(--dark-text);
            border: 1px solid var(--dark-input-border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.15);
            font-family: 'Segoe UI', -apple-system, system-ui, sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            margin-bottom: 20px;
            resize: vertical;
            min-height: 60px;
        }
        
        body.dark-mode #userInput:focus {
            border-color: var(--dark-primary);
            box-shadow: 0 0 0 3px var(--dark-highlight-alpha), inset 0 2px 10px rgba(0, 0, 0, 0.15);
            background-color: rgba(30, 30, 45, 0.8);
        }
        
        body.dark-mode .copy-btn {
            background-color: var(--dark-accent);
            opacity: 0.7;
            font-size: 12px;
            padding: 4px 10px;
            transition: all 0.2s;
            border-radius: 6px;
            color: var(--dark-text);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--dark-border);
        }
        
        body.dark-mode .copy-btn:hover {
            opacity: 1;
            background-color: var(--dark-primary);
            color: white;
            transform: translateY(-1px);
            border-color: transparent;
        }
        
        body.dark-mode .status-container {
            float: right;
            margin-top: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 20px;
            background-color: rgba(30, 30, 45, 0.7);
            box-shadow: 0 4px 12px var(--dark-shadow);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--dark-border);
        }
        
        body.dark-mode .status-connected {
            background-color: var(--dark-status-good);
            box-shadow: 0 0 10px var(--dark-status-good), 0 0 15px rgba(74, 222, 128, 0.3);
            animation: pulse 2s infinite;
        }
        
        body.dark-mode .status-disconnected {
            background-color: var(--dark-status-bad);
            box-shadow: 0 0 10px var(--dark-status-bad), 0 0 15px rgba(248, 113, 113, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 10px currentColor, 0 0 15px currentColor; }
            50% { box-shadow: 0 0 15px currentColor, 0 0 20px currentColor; opacity: 0.8; }
            100% { box-shadow: 0 0 10px currentColor, 0 0 15px currentColor; }
        }
        
        body.dark-mode .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            position: relative;
        }
        
        body.dark-mode .settings-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--dark-border), transparent);
            margin: 20px 0;
        }
        
        body.dark-mode label {
            color: var(--dark-secondary-text);
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
        }
        
        body.dark-mode .typing-indicator {
            display: none;
            align-items: center;
            margin: 10px 0;
            padding: 10px 18px;
            background: var(--dark-gradient-1);
            border-radius: 20px;
            width: fit-content;
            box-shadow: 0 4px 12px var(--dark-shadow);
            animation: fadeIn 0.3s ease;
            font-size: 14px;
            border: 1px solid var(--dark-border);
            position: relative;
            overflow: hidden;
        }
        
        body.dark-mode .typing-indicator::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--dark-primary), transparent);
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        body.dark-mode .typing-indicator span {
            color: var(--dark-secondary-text);
            margin-right: 8px;
            font-weight: 500;
        }
        
        body.dark-mode .typing-dot {
            height: 8px;
            width: 8px;
            background-color: var(--dark-primary);
            border-radius: 50%;
            margin: 0 3px;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
            box-shadow: 0 0 8px rgba(124, 90, 240, 0.5);
        }
        
        /* Enhance code blocks with better styling */
        body.dark-mode pre {
            background: linear-gradient(145deg, #191922, #15151a);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            overflow-x: auto;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #e0e0e0;
        }
        
        body.dark-mode .code-header {
            display: flex;
            justify-content: flex-end;
            padding: 8px;
            background: rgba(30, 30, 45, 0.6);
            border-bottom: 1px solid var(--dark-border);
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
        }
        
        body.dark-mode .code-block {
            padding-top: 40px;
            position: relative;
            margin-bottom: 20px;
        }
        
        /* Improve syntax highlighting */
        body.dark-mode .token.comment {
            color: #6c7086;
            font-style: italic;
        }
        
        body.dark-mode .token.string {
            color: #a6e3a1;
        }
        
        body.dark-mode .token.keyword {
            color: #cba6f7;
            font-weight: bold;
        }
        
        body.dark-mode .token.function {
            color: #89b4fa;
        }
        
        body.dark-mode .token.number {
            color: #f38ba8;
        }
        
        body.dark-mode .token.operator {
            color: #94e2d5;
        }
        
        body.dark-mode .token.variable {
            color: #fab387;
        }
        
        body.dark-mode #toggleSettingsBtn {
            background: transparent;
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            padding: 0;
            font-size: 12px;
        }
        
        body.dark-mode #toggleSettingsBtn:hover {
            background: var(--dark-hover-bg);
            transform: none;
            box-shadow: none;
            border-color: var(--dark-primary);
        }
        `;
        document.head.appendChild(darkStyle);

        // Chat history persistence
        function saveChatHistory() {
            localStorage.setItem('chatHistory', document.getElementById('chatLog').innerHTML);
        }

        function loadChatHistory() {
            const history = localStorage.getItem('chatHistory');
            if (history) {
                document.getElementById('chatLog').innerHTML = history;
                // Re-attach copy buttons
                attachCopyButtons();
            }
        }

        // Enhanced Markdown rendering for AI responses
        function renderMarkdown(text) {
            // Configure marked options for better code blocks
            marked.setOptions({
                highlight: function (code, lang) {
                    // Basic syntax highlighting
                    if (!lang) return code;

                    // Simple syntax highlighting for common languages
                    const keywords = {
                        'js': ['const', 'let', 'var', 'function', 'return', 'if', 'else', 'for', 'while', 'class', 'import', 'export', 'async', 'await', 'try', 'catch'],
                        'python': ['def', 'class', 'import', 'from', 'return', 'if', 'elif', 'else', 'for', 'while', 'try', 'except', 'with', 'as', 'lambda'],
                        'html': ['html', 'head', 'body', 'div', 'span', 'h1', 'h2', 'h3', 'p', 'a', 'img', 'script', 'style', 'link', 'meta', 'title'],
                        'css': ['body', 'div', 'class', 'id', 'margin', 'padding', 'color', 'background', 'font', 'display', 'flex', 'grid', 'border']
                    };

                    // Get keywords for this language or fallback to empty array
                    const langKeywords = keywords[lang] || [];

                    // Very simple highlighting
                    let result = code;
                    langKeywords.forEach(keyword => {
                        const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                        result = result.replace(regex, `<span class="token keyword">${keyword}</span>`);
                    });

                    // Simple string highlighting (very basic)
                    result = result.replace(/(["'`])(.*?)\1/g, '<span class="token string">$1$2$1</span>');

                    // Simple comment highlighting (very basic)
                    if (lang === 'js' || lang === 'javascript') {
                        result = result.replace(/(\/\/.*$)/gm, '<span class="token comment">$1</span>');
                    } else if (lang === 'python') {
                        result = result.replace(/(#.*$)/gm, '<span class="token comment">$1</span>');
                    }

                    return result;
                },
                breaks: true,
                gfm: true
            });

            // Process markdown
            let html = marked.parse(text);

            // Add copy buttons to code blocks
            html = html.replace(/<pre><code([^>]*)>([\s\S]*?)<\/code><\/pre>/g,
                '<pre class="code-block"><div class="code-header"><button class="code-copy-btn">Copy</button></div><code$1>$2</code></pre>');

            return html;
        }

        // Enhanced copy buttons for AI messages and code blocks
        function attachCopyButtons() {
            // For entire AI messages
            document.querySelectorAll('.ai-message').forEach(div => {
                if (!div.querySelector('.message-copy-btn')) {
                    const btn = document.createElement('button');
                    btn.textContent = 'Copy';
                    btn.className = 'copy-btn message-copy-btn';
                    btn.title = 'Copy entire message';

                    // Only get content from message-content div if it exists
                    btn.onclick = function (e) {
                        e.stopPropagation();
                        let textToCopy = '';
                        const contentDiv = div.querySelector('.message-content');
                        if (contentDiv) {
                            textToCopy = contentDiv.innerText;
                        } else {
                            textToCopy = div.innerText.replace(/Copy|Copied!/g, '').trim();
                        }

                        navigator.clipboard.writeText(textToCopy);
                        btn.textContent = 'Copied!';
                        btn.style.backgroundColor = document.body.classList.contains('dark-mode') ?
                            'var(--dark-primary)' : '#4caf50';
                        setTimeout(() => {
                            btn.textContent = 'Copy';
                            btn.style.backgroundColor = '';
                        }, 1500);
                    };

                    // Add to the first child if it's a message with header row
                    if (div.firstElementChild && div.firstElementChild.style &&
                        div.firstElementChild.style.display === 'flex') {
                        div.firstElementChild.appendChild(btn);
                    } else {
                        div.appendChild(btn);
                    }
                }
            });

            // For code blocks
            document.querySelectorAll('.code-copy-btn').forEach(btn => {
                if (!btn.hasEventListener) {
                    btn.hasEventListener = true;
                    btn.onclick = function () {
                        const codeBlock = this.closest('.code-block').querySelector('code');
                        navigator.clipboard.writeText(codeBlock.innerText);
                        this.textContent = 'Copied!';
                        this.style.backgroundColor = document.body.classList.contains('dark-mode') ?
                            'var(--dark-primary)' : '#4caf50';
                        setTimeout(() => {
                            this.textContent = 'Copy';
                            this.style.backgroundColor = '';
                        }, 1500);
                    };
                }
            });

            // Add styling for code blocks if not already added
            if (!document.getElementById('code-block-styles')) {
                const style = document.createElement('style');
                style.id = 'code-block-styles';
                style.textContent = `
                    .code-block {
                        position: relative;
                        margin: 1em 0;
                        border-radius: 6px;
                        overflow: hidden;
                    }
                    
                    .code-header {
                        display: flex;
                        justify-content: flex-end;
                        padding: 4px 8px;
                        background-color: rgba(0,0,0,0.1);
                        border-bottom: 1px solid rgba(0,0,0,0.15);
                    }
                    
                    body.dark-mode .code-header {
                        background-color: rgba(0,0,0,0.3);
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }
                    
                    .code-copy-btn {
                        font-size: 11px;
                        padding: 2px 6px;
                        background-color: transparent;
                        border: 1px solid rgba(0,0,0,0.2);
                        opacity: 0.7;
                        transition: all 0.2s;
                    }
                    
                    .code-copy-btn:hover {
                        opacity: 1;
                        background-color: rgba(0,0,0,0.1);
                    }
                    
                    body.dark-mode .code-copy-btn {
                        border: 1px solid rgba(255,255,255,0.2);
                        color: #e0e0e0;
                    }
                    
                    body.dark-mode .code-copy-btn:hover {
                        background-color: rgba(255,255,255,0.1);
                    }
                `;
                document.head.appendChild(style);
            }
        }

        async function checkBackendStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch('http://localhost:8000/ping');
                if (response.ok) {
                    statusIndicator.className = 'status-indicator status-connected';
                    statusText.textContent = 'Connected to backend';
                    return true;
                } else {
                    statusIndicator.className = 'status-indicator status-disconnected';
                    statusText.textContent = 'Backend error';
                    return false;
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'Backend disconnected';
                return false;
            }
        }

        function clearChat() {
            document.getElementById('chatLog').innerHTML = '';
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'ai-message';
            aiMessageDiv.innerHTML = renderMarkdown("Chat cleared. How can I help you today?");
            document.getElementById('chatLog').appendChild(aiMessageDiv);
            attachCopyButtons();
            saveChatHistory();
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) return;

            // Disable send button and show typing indicator
            document.getElementById('sendButton').disabled = true;
            document.getElementById('typingIndicator').style.display = 'flex';

            // Add user message to chat with timestamp
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message';

            // Add timestamp display
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'message-timestamp';
            timestampSpan.textContent = timestamp;
            timestampSpan.style.fontSize = '0.75em';
            timestampSpan.style.opacity = '0.7';
            timestampSpan.style.marginTop = '5px';
            timestampSpan.style.display = 'block';
            timestampSpan.style.textAlign = 'right';

            // Create message content element
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = userInput;

            userMessageDiv.appendChild(messageContent);
            userMessageDiv.appendChild(timestampSpan);
            document.getElementById('chatLog').appendChild(userMessageDiv);

            // Clear input and scroll to bottom with animation
            document.getElementById('userInput').value = "";
            smoothScrollToBottom();
            saveChatHistory();

            try {
                // Get settings from UI
                const model = document.getElementById('modelSelect').value;
                const temperature = parseFloat(document.getElementById('temperatureInput').value);
                const maxTokens = parseInt(document.getElementById('maxTokensInput').value);
                const systemPrompt = document.getElementById('systemPrompt').value;

                // Create and show typing indicator inside chat
                const typingInChatDiv = document.createElement('div');
                typingInChatDiv.className = 'ai-message typing-message';
                typingInChatDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
                document.getElementById('chatLog').appendChild(typingInChatDiv);
                smoothScrollToBottom();

                // Send request to our backend API
                const response = await fetch('http://localhost:8000/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: userInput,
                        model: model,
                        system: systemPrompt,
                        temperature: temperature,
                        max_tokens: maxTokens
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById('chatLog').removeChild(typingInChatDiv);

                // Add AI response to chat (markdown) with timestamp
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'ai-message';

                const aiTimestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const aiTimestampSpan = document.createElement('span');
                aiTimestampSpan.className = 'message-timestamp';
                aiTimestampSpan.textContent = aiTimestamp;
                aiTimestampSpan.style.fontSize = '0.75em';
                aiTimestampSpan.style.opacity = '0.7';
                aiTimestampSpan.style.marginTop = '5px';
                aiTimestampSpan.style.display = 'block';

                const modelLabel = document.createElement('span');
                modelLabel.className = 'model-label';
                modelLabel.textContent = model.split('/').pop() || model;
                modelLabel.style.fontSize = '0.75em';
                modelLabel.style.opacity = '0.7';
                modelLabel.style.marginRight = '5px';

                const headerRow = document.createElement('div');
                headerRow.style.display = 'flex';
                headerRow.style.justifyContent = 'space-between';
                headerRow.style.marginBottom = '8px';
                headerRow.appendChild(modelLabel);
                headerRow.appendChild(aiTimestampSpan);

                const aiContent = document.createElement('div');
                aiContent.className = 'message-content';
                aiContent.innerHTML = renderMarkdown(data.reply || "Sorry, I couldn't process your request.");

                aiMessageDiv.appendChild(headerRow);
                aiMessageDiv.appendChild(aiContent);
                document.getElementById('chatLog').appendChild(aiMessageDiv);

                // Animate content appearance
                aiContent.style.opacity = '0';
                setTimeout(() => {
                    aiContent.style.transition = 'opacity 0.5s ease';
                    aiContent.style.opacity = '1';
                }, 50);

                attachCopyButtons();
                smoothScrollToBottom();
                saveChatHistory();

                // Optionally speak the response if TTS is enabled
                if (ttsEnabled) {
                    speakText(data.reply || "Sorry, I couldn't process your request.");
                }

            } catch (error) {
                console.error("Error communicating with backend:", error);

                // Show error message in chat
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message error-message';
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="color: #f44336; margin-right: 8px;">⚠️</span>
                        <span style="font-weight: bold; color: #f44336;">Connection Error</span>
                    </div>
                    <div>Cannot connect to backend server. Please check if the server is running.</div>
                `;
                document.getElementById('chatLog').appendChild(errorDiv);
                smoothScrollToBottom();
                saveChatHistory();
            } finally {
                // Re-enable send button and hide typing indicator
                document.getElementById('sendButton').disabled = false;
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }

        // Smooth scrolling to bottom of chat
        function smoothScrollToBottom() {
            const chatLog = document.getElementById('chatLog');
            const scrollHeight = chatLog.scrollHeight;
            const scrollAnimationDuration = 300; // ms
            const startTime = performance.now();
            const startScrollTop = chatLog.scrollTop;
            const distance = scrollHeight - chatLog.clientHeight - startScrollTop;

            function step(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / scrollAnimationDuration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
                chatLog.scrollTop = startScrollTop + distance * easeProgress;

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            }

            window.requestAnimationFrame(step);
        }

        // --- Advanced Features JS ---
        // File upload handler
        function handleFileUpload() {
            const files = document.getElementById('fileUpload').files;
            if (!files.length) return;
            // Example: send first file as base64 (customize for your backend)
            const reader = new FileReader();
            reader.onload = async function (e) {
                const fileContent = e.target.result.split(',')[1];
                await sendMessageWithFile(fileContent, files[0].name);
            };
            reader.readAsDataURL(files[0]);
        }
        async function sendMessageWithFile(fileContent, fileName) {
            // Add user message to chat
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message';
            userMessageDiv.textContent = `Uploaded file: ${fileName}`;
            document.getElementById('chatLog').appendChild(userMessageDiv);
            saveChatHistory();
            // Send to backend (customize endpoint as needed)
            try {
                const response = await fetch('http://localhost:8000/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: fileContent, filename: fileName })
                });
                const data = await response.json();
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'ai-message';
                aiMessageDiv.innerHTML = renderMarkdown(data.reply || 'File processed.');
                document.getElementById('chatLog').appendChild(aiMessageDiv);
                attachCopyButtons();
                saveChatHistory();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.style.color = 'red';
                errorDiv.textContent = 'Error: File upload failed.';
                document.getElementById('chatLog').appendChild(errorDiv);
                saveChatHistory();
            }
        }

        // Export chat
        function exportChat(type) {
            const chatLog = document.getElementById('chatLog').innerText;
            let content = chatLog;
            let mime = 'text/plain';
            let ext = 'txt';
            if (type === 'md') { content = document.getElementById('chatLog').innerHTML; mime = 'text/markdown'; ext = 'md'; }
            if (type === 'pdf') { alert('PDF export coming soon!'); return; }
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_export.${ext}`;
            a.click();
            URL.revokeObjectURL(url);
        }
        };

        // Prompt presets
        document.getElementById('presetSelect').addEventListener('change', function () {
            const preset = this.value;
            if (preset === 'friendly') document.getElementById('systemPrompt').value = 'You are a friendly helpful assistant.';
            if (preset === 'coder') document.getElementById('systemPrompt').value = 'You are an expert coding assistant.';
            if (preset === 'summarizer') document.getElementById('systemPrompt').value = 'Summarize any text or document provided.';
            if (preset === '') document.getElementById('systemPrompt').value = '';
        });

        // Image generation
        async function generateImage() {
            const prompt = prompt('Describe the image you want to generate:');
            if (!prompt) return;
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message';
            userMessageDiv.textContent = `[Image Generation] ${prompt}`;
            document.getElementById('chatLog').appendChild(userMessageDiv);
            saveChatHistory();
            try {
                const response = await fetch('http://localhost:8000/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await response.json();
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'ai-message';
                if (data.image_url) {
                    aiMessageDiv.innerHTML = `<img src="${data.image_url}" alt="Generated Image" style="max-width:100%"><br>${renderMarkdown(data.caption || '')}`;
                } else {
                    aiMessageDiv.innerHTML = renderMarkdown(data.reply || 'Image generation failed.');
                }
                document.getElementById('chatLog').appendChild(aiMessageDiv);
                attachCopyButtons();
                saveChatHistory();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.style.color = 'red';
                errorDiv.textContent = 'Error: Image generation failed.';
                document.getElementById('chatLog').appendChild(errorDiv);
                saveChatHistory();
            }
        }

        // API key save
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value;
            localStorage.setItem('apiKey', key);
            alert('API Key saved locally.');
        }

        // Theme change with persistence
        function changeTheme() {
            const theme = document.getElementById('themeSelect').value;
            document.body.classList.remove('dark-mode', 'high-contrast');

            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else if (theme === 'high-contrast') {
                document.body.classList.add('high-contrast');
                localStorage.setItem('theme', 'high-contrast');
            } else {
                localStorage.setItem('theme', 'light');
            }

            // Update dark mode toggle button state
            const darkModeBtn = document.getElementById('darkModeBtn');
            darkModeBtn.textContent = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';

            // Smooth transition effect
            document.body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 300);
        }
    </script>
</body>

</html>